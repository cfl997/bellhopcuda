#include <iostream>
#include <vector>
#include <thread>
#include <chrono>
#include <string>
#include <filesystem>
#include <cmath>
#include <algorithm>

#include "TEDSbellhop/TEDSbellhop.hpp"
#include "tl_png.hpp"

#ifdef _WIN32
#define NOMINMAX
#include <windows.h>
#endif

// 最终版：根据用户提供的完整 2D SSP 矩阵进行测试
// - 使用用户指定的非均匀水平距离网格，并进行 15% 的拉伸。
// - 直接填充用户提供的 c(z,r) 声速矩阵。
// - 规避 TEDSbellhop 库的 Q-SSP 实现 bug。

static tedsbellhop::TL2DInput create_base_input_from_user_matrix()
{
    using namespace tedsbellhop;

    TL2DInput in;

    in.title   = "TEDSbellhop Test with User-Provided 2D SSP Matrix";
    in.freq_hz = 1000.0;
    in.options = "Q";

    in.run_type.use_raw = false;
    in.run_type.tl   = TLCoherence::Incoherent;
    in.run_type.infl = Influence::GeomGaussianCartesian;

    //in.prt_callback = [](const char*) {};
    //in.output_callback = [](const char*) {};

    // -----------------------------
    // 1) 射线
    // -----------------------------
    in.n_rays = 2000;
    in.start_angle_deg = -90.0;
    in.end_angle_deg   = 90.0;

    // -----------------------------
    // 2) TL 输出网格 (0..10km, 0..5000m)
    // -----------------------------
    in.pos.receiver_ranges.resize(1001);
    for(int i = 0; i < 1001; ++i) in.pos.receiver_ranges[i] = float(i) * 10.0f;
    in.pos.receiver_depths_m.resize(501);
    for(int i = 0; i < 501; ++i) in.pos.receiver_depths_m[i] = float(i) * 10.0f;

    // -----------------------------
    // 3) 边界
    // -----------------------------
    double max_ssp_range_m = 115.6155 * 1.15; // 按照用户描述进行拉伸
    double min_ssp_range_m = -max_ssp_range_m;

    in.boundaries.top.bc = BoundaryCondition::Vacuum;
    in.boundaries.bottom.bc = BoundaryCondition::Rigid;
    in.boundaries.top_curve.r = {min_ssp_range_m, max_ssp_range_m};
    in.boundaries.top_curve.z = {0.0, 0.0};
    in.boundaries.bottom_curve.interp = BoundaryInterp::Linear;
    // 参考其他测试用例的写法：用一个“平滑起伏”的合成海底，确保：
    // - 覆盖 0..box_x_m（这里 0..10000m）
    // - 不引入很陡的折线，避免数值/几何问题
    // - 深度整体落在 box_z_m 之内（这里 box_z_m=6000m，所以海底选 ~5200m 左右）
    const int Nb = 50;
    in.boundaries.bottom_curve.r.resize(Nb);
    in.boundaries.bottom_curve.z.resize(Nb);

    const double base_bot = 4200.0;                // 平均海底深度（m）
    const double A1 = 350.0;                      // 主起伏幅度（m）
    const double A2 = 200;                       // 次起伏幅度（m）
    constexpr double kPi = 3.14159265358979323846;

    for (int i = 0; i < Nb; ++i) {
        double t = (Nb == 1) ? 0.0 : double(i) / double(Nb - 1);
        double rr = in.beam.box_x_m * t;           // 0..box_x_m

        // 两个频率叠加 + 相位偏移
        double und = A1 * std::sin(2.0 * kPi * t)
                   + A2 * std::sin(2.0 * kPi * 3.0 * t + 0.7);

        in.boundaries.bottom_curve.r[i] = rr;
        in.boundaries.bottom_curve.z[i] = base_bot + und;
    }

    // -----------------------------
    // 4) box & deltas
    // -----------------------------
    in.beam.box_x_m = 10000.0;
    in.beam.box_z_m = 6000.0;
    in.beam.deltas_m = 50.0;

    // -----------------------------
    // 5) Q-SSP (2D) - 直接使用用户提供的矩阵
    // -----------------------------
    in.ssp.type = SSPType::Quad;

    // 水平距离网格 (m)
    // 注意：这里必须用米；原始数据是 km，需要 *1000。
    in.ssp_quad.ranges = {
        -115.6155f * 1000.0f,
        0.0f,
        2.0f * 1000.0f,
        4.0f * 1000.0f,
        6.0f * 1000.0f,
        8.0f * 1000.0f,
        10.0f * 1000.0f,
        12.0f * 1000.0f,
        14.0f * 1000.0f,
        16.0f * 1000.0f,
        18.0f * 1000.0f,
        20.0f * 1000.0f,
        22.0f * 1000.0f,
        24.0f * 1000.0f,
        26.0f * 1000.0f,
        28.0f * 1000.0f,
        30.0f * 1000.0f,
        115.6155f * 1000.0f
    };
    in.ssp_quad.ranges_in_km = false;

    // 深度网格 (m)
    const std::vector<float> ssp_depths = {
        0, 1, 2, 3, 5, 6, 7, 9, 11, 13, 15, 18, 21, 25, 29, 34, 40, 47, 55, 65, 77, 
        92, 109, 130, 155, 186, 222, 266, 318, 380, 453, 541, 643, 763, 902, 1062, 
        1245, 1452, 1684, 1941, 2225, 2533, 2865, 3220, 3597, 3992, 4405, 4833, 
        5274, 5727
    };
    in.ssp_quad.depths_m = ssp_depths;

    // 为规避库 bug，必须同时填充 ssp.points
    in.ssp.points.resize(ssp_depths.size());
    for(size_t i = 0; i < ssp_depths.size(); ++i) {
        in.ssp.points[i].z_m = ssp_depths[i];
    }

    // 声速矩阵 c(z,r)
    // 维度: Nz(=52) x Nr(=18)，行优先存储：c[iz * Nr + ir]
    // 下方数据来自你粘贴的矩阵（每行 18 个值）。
    const std::vector<float> ssp_c_matrix = {
        // row 0
        1538.868896484375f, 1538.868896484375f, 1539.2100830078125f, 1539.4378662109375f, 1539.927001953125f, 1540.0731201171875f, 1540.448486328125f, 1540.56787109375f, 1540.8472900390625f, 1540.941162109375f, 1541.1519775390625f, 1541.2392578125f, 1541.5885009765625f, 1541.643310546875f, 1541.92138671875f, 1541.9443359375f, 1542.152587890625f, 1542.152587890625f,
        // row 1
        1538.8856201171875f, 1538.8856201171875f, 1539.2259521484375f, 1539.45458984375f, 1539.9444580078125f, 1540.091064453125f, 1540.4698486328125f, 1540.588134765625f, 1540.8662109375f, 1540.960205078125f, 1541.1710205078125f, 1541.25830078125f, 1541.6077880859375f, 1541.6627197265625f, 1541.9403076171875f, 1541.9632568359375f, 1542.1710205078125f, 1542.1710205078125f,
        // row 2
        1538.890380859375f, 1538.890380859375f, 1539.232177734375f, 1539.4625244140625f, 1539.955322265625f, 1540.103515625f, 1540.4862060546875f, 1540.6051025390625f, 1540.8826904296875f, 1540.9766845703125f, 1541.187744140625f, 1541.2750244140625f, 1541.6246337890625f, 1541.679443359375f, 1541.956787109375f, 1541.9798583984375f, 1542.1876220703125f, 1542.1876220703125f,
        // row 3
        1538.883056640625f, 1538.883056640625f, 1539.22802734375f, 1539.4593505859375f, 1539.95654296875f, 1540.107177734375f, 1540.494140625f, 1540.6138916015625f, 1540.891845703125f, 1540.9859619140625f, 1541.1973876953125f, 1541.2847900390625f, 1541.635498046875f, 1541.6900634765625f, 1541.968017578125f, 1541.9910888671875f, 1542.199462890625f, 1542.199462890625f,
        // row 4
        1538.864501953125f, 1538.864501953125f, 1539.211669921875f, 1539.4478759765625f, 1539.951904296875f, 1540.1033935546875f, 1540.4947509765625f, 1540.6146240234375f, 1540.8944091796875f, 1540.9892578125f, 1541.201416015625f, 1541.2889404296875f, 1541.640869140625f, 1541.695068359375f, 1541.9737548828125f, 1541.9969482421875f, 1542.2054443359375f, 1542.2054443359375f,
        // row 5
        1538.8448486328125f, 1538.8448486328125f, 1539.194580078125f, 1539.4306640625f, 1539.9371337890625f, 1540.0908203125f, 1540.484130859375f, 1540.605712890625f, 1540.8876953125f, 1540.9842529296875f, 1541.1968994140625f, 1541.2850341796875f, 1541.637939453125f, 1541.692626953125f, 1541.9720458984375f, 1541.995849609375f, 1542.2049560546875f, 1542.2049560546875f,
        // row 6
        1538.8135986328125f, 1538.8135986328125f, 1539.17138671875f, 1539.4111328125f, 1539.925048828125f, 1540.081298828125f, 1540.4737548828125f, 1540.5968017578125f, 1540.884033203125f, 1540.98193359375f, 1541.1949462890625f, 1541.283935546875f, 1541.6365966796875f, 1541.6907958984375f, 1541.97265625f, 1541.995849609375f, 1542.20556640625f, 1542.20556640625f,
        // row 7
        1538.76513671875f, 1538.76513671875f, 1539.1302490234375f, 1539.3814697265625f, 1539.9083251953125f, 1540.0673828125f, 1540.4630126953125f, 1540.5892333984375f, 1540.8812255859375f, 1540.9759521484375f, 1541.193603515625f, 1541.281982421875f, 1541.635498046875f, 1541.6893310546875f, 1541.973876953125f, 1541.997314453125f, 1542.209716796875f, 1542.209716796875f,
        // row 8
        1538.6956787109375f, 1538.6956787109375f, 1539.0635986328125f, 1539.33154296875f, 1539.8663330078125f, 1540.024169921875f, 1540.427490234375f, 1540.5584716796875f, 1540.86865234375f, 1540.96142578125f, 1541.1875f, 1541.2713623046875f, 1541.6240234375f, 1541.6778564453125f, 1541.970458984375f, 1541.9935302734375f, 1542.2117919921875f, 1542.2117919921875f,
        // row 9
        1538.570556640625f, 1538.570556640625f, 1538.895751953125f, 1539.1839599609375f, 1539.71044921875f, 1539.8739013671875f, 1540.31396484375f, 1540.451416015625f, 1540.7939453125f, 1540.8856201171875f, 1541.1268310546875f, 1541.197021484375f, 1541.5521240234375f, 1541.60498046875f, 1541.9332275390625f, 1541.9468994140625f, 1542.19140625f, 1542.19140625f,
        // row 10
        1538.2947998046875f, 1538.2947998046875f, 1538.6002197265625f, 1538.8912353515625f, 1539.429931640625f, 1539.5888671875f, 1540.066162109375f, 1540.1905517578125f, 1540.5478515625f, 1540.63671875f, 1540.8990478515625f, 1540.9727783203125f, 1541.3726806640625f, 1541.4071044921875f, 1541.79296875f, 1541.7939453125f, 1542.0989990234375f, 1542.0989990234375f,
        // row 11
        1537.9190673828125f, 1537.9190673828125f, 1538.2071533203125f, 1538.4779052734375f, 1539.051513671875f, 1539.228515625f, 1539.705078125f, 1539.82958984375f, 1540.2216796875f, 1540.3353271484375f, 1540.63427734375f, 1540.7178955078125f, 1541.1270751953125f, 1541.1593017578125f, 1541.5621337890625f, 1541.55126953125f, 1541.8905029296875f, 1541.8905029296875f,
        // row 12
        1537.5203857421875f, 1537.5203857421875f, 1537.781005859375f, 1538.01318359375f, 1538.5992431640625f, 1538.787353515625f, 1539.28759765625f, 1539.421875f, 1539.8648681640625f, 1539.984375f, 1540.340087890625f, 1540.4296875f, 1540.8568115234375f, 1540.884765625f, 1541.2738037109375f, 1541.2596435546875f, 1541.6014404296875f, 1541.6014404296875f,
        // row 13
        1537.0594482421875f, 1537.0594482421875f, 1537.2904052734375f, 1537.4766845703125f, 1538.07275390625f, 1538.2908935546875f, 1538.8197021484375f, 1538.9578857421875f, 1539.4608154296875f, 1539.5853271484375f, 1539.9859619140625f, 1540.079345703125f, 1540.4866943359375f, 1540.5057373046875f, 1540.8607177734375f, 1540.8411865234375f, 1541.2020263671875f, 1541.2020263671875f,
        // row 14
        1536.50830078125f, 1536.50830078125f, 1536.749267578125f, 1536.89697265625f, 1537.4893798828125f, 1537.7181396484375f, 1538.2774658203125f, 1538.4285888671875f, 1538.9720458984375f, 1539.0931396484375f, 1539.517333984375f, 1539.579345703125f, 1539.937744140625f, 1539.941162109375f, 1540.327392578125f, 1540.28076171875f, 1540.718017578125f, 1540.718017578125f,
        // row 15
        1535.7532958984375f, 1535.7532958984375f, 1536.08349609375f, 1536.2249755859375f, 1536.7569580078125f, 1536.9549560546875f, 1537.5357666015625f, 1537.691650390625f, 1538.262939453125f, 1538.368896484375f, 1538.7802734375f, 1538.8038330078125f, 1539.1568603515625f, 1539.130859375f, 1539.6103515625f, 1539.5186767578125f, 1540.059326171875f, 1540.059326171875f,
        // row 16
        1534.7716064453125f, 1534.7716064453125f, 1535.121337890625f, 1535.2847900390625f, 1535.817626953125f, 1535.984619140625f, 1536.5572509765625f, 1536.6864013671875f, 1537.2022705078125f, 1537.2691650390625f, 1537.6614990234375f, 1537.6595458984375f, 1538.0103759765625f, 1537.9486083984375f, 1538.4725341796875f, 1538.340576171875f, 1538.950439453125f, 1538.950439453125f,
        // row 17
        1533.6019287109375f, 1533.6019287109375f, 1533.9888916015625f, 1534.1593017578125f, 1534.71728515625f, 1534.8897705078125f, 1535.4483642578125f, 1535.552001953125f, 1535.9749755859375f, 1536.023193359375f, 1536.3499755859375f, 1536.3504638671875f, 1536.69677734375f, 1536.6361083984375f, 1537.137939453125f, 1537.00634765625f, 1537.568359375f, 1537.568359375f,
        // row 18
        1532.3236083984375f, 1532.3236083984375f, 1532.7855224609375f, 1532.9510498046875f, 1533.5291748046875f, 1533.7208251953125f, 1534.2430419921875f, 1534.3306884765625f, 1534.68359375f, 1534.70849609375f, 1534.9986572265625f, 1534.99755859375f, 1535.383056640625f, 1535.3250732421875f, 1535.8526611328125f, 1535.7308349609375f, 1536.250732421875f, 1536.250732421875f,
        // row 19
        1530.96435546875f, 1530.96435546875f, 1531.4971923828125f, 1531.703125f, 1532.322021484375f, 1532.5126953125f, 1533.012939453125f, 1533.09765625f, 1533.4129638671875f, 1533.427490234375f, 1533.7196044921875f, 1533.7384033203125f, 1534.15478515625f, 1534.1114501953125f, 1534.6136474609375f, 1534.5032958984375f, 1534.9786376953125f, 1534.9786376953125f,
        // row 20
        1529.618896484375f, 1529.618896484375f, 1530.2125244140625f, 1530.441650390625f, 1531.113525390625f, 1531.3084716796875f, 1531.803466796875f, 1531.90283203125f, 1532.23583984375f, 1532.262939453125f, 1532.6011962890625f, 1532.63720703125f, 1533.0838623046875f, 1533.0457763671875f, 1533.5137939453125f, 1533.4189453125f, 1533.8243408203125f, 1533.8243408203125f,
        // row 21
        1528.30419921875f, 1528.30419921875f, 1528.9407958984375f, 1529.15234375f, 1529.815185546875f, 1530.0289306640625f, 1530.5289306640625f, 1530.6221923828125f, 1531.0126953125f, 1531.072265625f, 1531.44580078125f, 1531.484130859375f, 1531.9381103515625f, 1531.9017333984375f, 1532.331298828125f, 1532.24365234375f, 1532.6241455078125f, 1532.6241455078125f,
        // row 22
        1526.997314453125f, 1526.997314453125f, 1527.59326171875f, 1527.76611328125f, 1528.3480224609375f, 1528.5364990234375f, 1529.06982421875f, 1529.195068359375f, 1529.6312255859375f, 1529.7020263671875f, 1530.1253662109375f, 1530.1671142578125f, 1530.6060791015625f, 1530.556396484375f, 1530.968017578125f, 1530.8695068359375f, 1531.2352294921875f, 1531.2352294921875f,
        // row 23
        1525.65625f, 1525.65625f, 1526.0946044921875f, 1526.276611328125f, 1526.7808837890625f, 1526.946044921875f, 1527.449462890625f, 1527.57470703125f, 1528.0509033203125f, 1528.140625f, 1528.603271484375f, 1528.6444091796875f, 1529.06396484375f, 1529.0054931640625f, 1529.3531494140625f, 1529.2652587890625f, 1529.5887451171875f, 1529.5887451171875f,
        // row 24
        1524.2557373046875f, 1524.2557373046875f, 1524.4920654296875f, 1524.615478515625f, 1525.01953125f, 1525.1746826171875f, 1525.6234130859375f, 1525.73291015625f, 1526.19482421875f, 1526.2803955078125f, 1526.7642822265625f, 1526.8099365234375f, 1527.166259765625f, 1527.1016845703125f, 1527.333984375f, 1527.2435302734375f, 1527.4700927734375f, 1527.4700927734375f,
        // row 25
        1522.309814453125f, 1522.309814453125f, 1522.38818359375f, 1522.504150390625f, 1522.6771240234375f, 1522.7247314453125f, 1523.0369873046875f, 1523.13427734375f, 1523.5340576171875f, 1523.59716796875f, 1523.94384765625f, 1523.9886474609375f, 1524.2880859375f, 1524.251708984375f, 1524.513427734375f, 1524.456298828125f, 1524.70703125f, 1524.70703125f,
        // row 26
        1519.5911865234375f, 1519.5911865234375f, 1519.6339111328125f, 1519.7515869140625f, 1519.840576171875f, 1519.9041748046875f, 1520.08984375f, 1520.1524658203125f, 1520.415283203125f, 1520.4998779296875f, 1520.776123046875f, 1520.8419189453125f, 1521.1607666015625f, 1521.1749267578125f, 1521.4700927734375f, 1521.4354248046875f, 1521.7205810546875f, 1521.7205810546875f,
        // row 27
        1516.4754638671875f, 1516.4754638671875f, 1516.5029296875f, 1516.660400390625f, 1516.804443359375f, 1516.900146484375f, 1517.06689453125f, 1517.1744384765625f, 1517.423095703125f, 1517.5091552734375f, 1517.714599609375f, 1517.78369140625f, 1518.0638427734375f, 1518.1075439453125f, 1518.385009765625f, 1518.394287109375f, 1518.5816650390625f, 1518.5816650390625f,
        // row 28
        1512.990234375f, 1512.990234375f, 1512.97705078125f, 1513.0662841796875f, 1513.1708984375f, 1513.298828125f, 1513.565185546875f, 1513.7232666015625f, 1514.0157470703125f, 1514.1728515625f, 1514.384765625f, 1514.472412109375f, 1514.6854248046875f, 1514.7152099609375f, 1514.881103515625f, 1514.8963623046875f, 1515.0809326171875f, 1515.0809326171875f,
        // row 29
        1508.2528076171875f, 1508.2528076171875f, 1508.0859375f, 1508.151611328125f, 1508.2052001953125f, 1508.3125f, 1508.5263671875f, 1508.7042236328125f, 1509.030517578125f, 1509.1734619140625f, 1509.4036865234375f, 1509.476806640625f, 1509.6046142578125f, 1509.5919189453125f, 1509.6971435546875f, 1509.6834716796875f, 1509.7364501953125f, 1509.7364501953125f,
        // row 30
        1501.9735107421875f, 1501.9735107421875f, 1501.7520751953125f, 1501.7880859375f, 1501.554443359375f, 1501.594482421875f, 1501.6776123046875f, 1501.78857421875f, 1502.0621337890625f, 1502.19970703125f, 1502.453369140625f, 1502.51318359375f, 1502.7403564453125f, 1502.7548828125f, 1502.84912109375f, 1502.8448486328125f, 1502.857666015625f, 1502.857666015625f,
        // row 31
        1494.4169921875f, 1494.4169921875f, 1494.0950927734375f, 1494.119140625f, 1494.0472412109375f, 1494.0892333984375f, 1494.064208984375f, 1494.115234375f, 1494.2314453125f, 1494.259033203125f, 1494.4014892578125f, 1494.4527587890625f, 1494.654541015625f, 1494.681884765625f, 1494.89599609375f, 1494.8780517578125f, 1495.0347900390625f, 1495.0347900390625f,
        // row 32
        1487.792236328125f, 1487.792236328125f, 1487.60693359375f, 1487.5543212890625f, 1487.5211181640625f, 1487.5679931640625f, 1487.6578369140625f, 1487.646728515625f, 1487.6246337890625f, 1487.6190185546875f, 1487.6121826171875f, 1487.6324462890625f, 1487.7789306640625f, 1487.8712158203125f, 1487.967529296875f, 1488.0347900390625f, 1488.075927734375f, 1488.075927734375f,
        // row 33
        1483.4862060546875f, 1483.4862060546875f, 1483.4144287109375f, 1483.337646484375f, 1483.3275146484375f, 1483.3387451171875f, 1483.389892578125f, 1483.481201171875f, 1483.4825439453125f, 1483.482666015625f, 1483.4727783203125f, 1483.5040283203125f, 1483.66162109375f, 1483.6982421875f, 1483.8765869140625f, 1483.92724609375f, 1483.9822998046875f, 1483.9822998046875f,
        // row 34
        1480.9671630859375f, 1480.9671630859375f, 1481.0655517578125f, 1481.0552978515625f, 1481.1663818359375f, 1481.2384033203125f, 1481.47314453125f, 1481.5643310546875f, 1481.7471923828125f, 1481.8009033203125f, 1481.9215087890625f, 1481.96875f, 1482.178955078125f, 1482.209228515625f, 1482.3382568359375f, 1482.3533935546875f, 1482.435791015625f, 1482.435791015625f,
        // row 35
        1480.5325927734375f, 1480.5325927734375f, 1480.5439453125f, 1480.5540771484375f, 1480.6624755859375f, 1480.6685791015625f, 1480.772705078125f, 1480.8338623046875f, 1480.909912109375f, 1480.9415283203125f, 1480.9853515625f, 1480.992431640625f, 1481.073974609375f, 1481.05859375f, 1481.2215576171875f, 1481.2020263671875f, 1481.3992919921875f, 1481.3992919921875f,
        // row 36
        1481.1275634765625f, 1481.1275634765625f, 1481.291259765625f, 1481.3358154296875f, 1481.421875f, 1481.45556640625f, 1481.5806884765625f, 1481.5633544921875f, 1481.6573486328125f, 1481.6600341796875f, 1481.71240234375f, 1481.7037353515625f, 1481.7203369140625f, 1481.699951171875f, 1481.699951171875f, 1481.7071533203125f, 1481.758544921875f, 1481.758544921875f,
        // row 37
        1483.05810546875f, 1483.05810546875f, 1483.079833984375f, 1483.064697265625f, 1483.0660400390625f, 1483.059326171875f, 1483.1181640625f, 1483.192138671875f, 1483.275146484375f, 1483.25244140625f, 1483.31201171875f, 1483.2801513671875f, 1483.36328125f, 1483.3541259765625f, 1483.421630859375f, 1483.37158203125f, 1483.3485107421875f, 1483.3485107421875f,
        // row 38
        1485.8192138671875f, 1485.8192138671875f, 1485.836669921875f, 1485.8746337890625f, 1485.925048828125f, 1485.9495849609375f, 1485.9381103515625f, 1485.88623046875f, 1485.8873291015625f, 1485.8946533203125f, 1485.9542236328125f, 1485.969970703125f, 1486.0074462890625f, 1485.9725341796875f, 1485.97607421875f, 1485.9437255859375f, 1486.000244140625f, 1486.000244140625f,
        // row 39
        1489.3427734375f, 1489.3427734375f, 1489.3739013671875f, 1489.403564453125f, 1489.39453125f, 1489.3955078125f, 1489.415771484375f, 1489.445068359375f, 1489.45166015625f, 1489.4517822265625f, 1489.426513671875f, 1489.3983154296875f, 1489.3394775390625f, 1489.3009033203125f, 1489.3353271484375f, 1489.3250732421875f, 1489.36279296875f, 1489.36279296875f,
        // row 40
        1493.5460205078125f, 1493.5460205078125f, 1493.569580078125f, 1493.5816650390625f, 1493.624267578125f, 1493.6435546875f, 1493.652099609375f, 1493.6866455078125f, 1493.7176513671875f, 1493.7408447265625f, 1493.771240234375f, 1493.7734375f, 1493.7801513671875f, 1493.7740478515625f, 1493.7984619140625f, 1493.79248046875f, 1493.8050537109375f, 1493.8050537109375f,
        // row 41
        1498.13720703125f, 1498.13720703125f, 1498.1796875f, 1498.19677734375f, 1498.2215576171875f, 1498.2425537109375f, 1498.2904052734375f, 1498.31103515625f, 1498.385009765625f, 1498.4261474609375f, 1498.497802734375f, 1498.5318603515625f, 1498.5821533203125f, 1498.5792236328125f, 1498.626708984375f, 1498.599365234375f, 1498.5908203125f, 1498.5908203125f,
        // row 42
        1503.466552734375f, 1503.466552734375f, 1503.45263671875f, 1503.4609375f, 1503.4793701171875f, 1503.505615234375f, 1503.5269775390625f, 1503.5614013671875f, 1503.6207275390625f, 1503.6693115234375f, 1503.73779296875f, 1503.7745361328125f, 1503.870361328125f, 1503.8837890625f, 1503.906005859375f, 1503.8787841796875f, 1503.8856201171875f, 1503.8856201171875f,
        // row 43
        1509.300048828125f, 1509.300048828125f, 1509.3306884765625f, 1509.3524169921875f, 1509.3687744140625f, 1509.37890625f, 1509.4189453125f, 1509.4356689453125f, 1509.477294921875f, 1509.51416015625f, 1509.5753173828125f, 1509.6219482421875f, 1509.694580078125f, 1509.7076416015625f, 1509.7420654296875f, 1509.7310791015625f, 1509.7462158203125f, 1509.7462158203125f,
        // row 44
        1515.73291015625f, 1515.73291015625f, 1515.7420654296875f, 1515.7510986328125f, 1515.7872314453125f, 1515.7967529296875f, 1515.7991943359375f, 1515.82080078125f, 1515.847412109375f, 1515.892578125f, 1515.9381103515625f, 1515.9820556640625f, 1516.0374755859375f, 1516.0445556640625f, 1516.069091796875f, 1516.0693359375f, 1516.087158203125f, 1516.087158203125f,
        // row 45
        1522.7271728515625f, 1522.7271728515625f, 1522.7265625f, 1522.728515625f, 1522.740234375f, 1522.7431640625f, 1522.7677001953125f, 1522.762451171875f, 1522.778076171875f, 1522.80126953125f, 1522.834228515625f, 1522.85888671875f, 1522.8953857421875f, 1522.9029541015625f, 1522.9296875f, 1522.9361572265625f, 1522.9573974609375f, 1522.9573974609375f,
        // row 46
        1530.1982421875f, 1530.1982421875f, 1530.2061767578125f, 1530.207763671875f, 1530.2288818359375f, 1530.2266845703125f, 1530.0408935546875f, 1530.007568359375f, 1530.01171875f, 1530.2650146484375f, 1530.284912109375f, 1530.278564453125f, 1530.3016357421875f, 1530.3006591796875f, 1530.332275390625f, 1530.3319091796875f, 1530.358154296875f, 1530.358154296875f,
        // row 47
        1538.0234375f, 1538.0234375f, 1537.963623046875f, 1537.96484375f, 1537.99560546875f, 1537.9881591796875f, 1537.584228515625f, 1537.521728515625f, 1537.5140380859375f, 1538.1083984375f, 1538.1246337890625f, 1538.0919189453125f, 1538.110107421875f, 1538.1046142578125f, 1538.145751953125f, 1538.13818359375f, 1538.1732177734375f, 1538.1732177734375f,
        // row 48
        1546.093994140625f, 1546.093994140625f, 1545.9642333984375f, 1545.965087890625f, 1546.005859375f, 1545.992919921875f, 1545.364013671875f, 1545.271484375f, 1545.2515869140625f, 1546.1976318359375f, 1546.2100830078125f, 1546.1502685546875f, 1546.163330078125f, 1546.1531982421875f, 1546.2042236328125f, 1546.2882080078125f, 1546.3282470703125f, 1546.3282470703125f,
        // row 49
        1548.1253587372448f, 1548.1253587372448f, 1547.9779924665179f, 1547.9787547831634f, 1548.0220457323555f, 1548.0077236460991f, 1547.3221908880739f, 1547.2221031967474f, 1547.1991332177402f, 1548.2336973852041f, 1548.2451960764774f, 1548.1785606332376f, 1548.1903316990858f, 1548.1790323062819f, 1548.2325464365433f, 1548.3395746970664f, 1548.3808734919749f, 1548.3808734919749f,
    };
    const size_t Nz = in.ssp_quad.depths_m.size();
    const size_t Nr = in.ssp_quad.ranges.size();

    if (ssp_c_matrix.size() != Nz * Nr) {
        throw std::runtime_error(
            "ssp_c_matrix 尺寸不匹配: 期望 " + std::to_string(Nz) + "x" + std::to_string(Nr) +
            "=" + std::to_string(Nz * Nr) + "，实际 " + std::to_string(ssp_c_matrix.size()));
    }

    in.ssp_quad.c_mps = ssp_c_matrix;

    return in;
}


int main() {
    #ifdef _WIN32
        SetConsoleOutputCP(CP_UTF8);
        SetConsoleCP(CP_UTF8);
    #endif
    
        const int num_profiles = 8;
    
        // 输出目录：test_teds_parallel_outputs
        const std::filesystem::path out_dir = "test_teds_parallel_outputs";
        std::error_code ec;
        std::filesystem::create_directories(out_dir, ec);
        if(ec) {
            std::cerr << "创建输出目录失败: " << out_dir.string() << " : " << ec.message() << "\n";
            return 2;
        }
    
        std::vector<tedsbellhop::TL2DJob> jobs;
        jobs.reserve(num_profiles);
    
        std::cout << "启动 " << num_profiles << " 个并行计算任务...\n";
    
        for (int i = 0; i < num_profiles; ++i) {
            auto in = create_base_input_from_user_matrix();
    
            // 为每个任务创建一个独特的输入（示例：改变声源深度）
            in.pos.source_depths_m = {static_cast<float>(20 + i * 50)};
            in.title = "TEDSbellhop Parallel Test - Profile " + std::to_string(i);
    
            std::cout << "  - 启动剖面 " << i << " (声源深度: " << in.pos.source_depths_m[0] << "m)\n";
            jobs.push_back(tedsbellhop::start_tl_2d(in));
        }
    
        std::cout << "\n所有任务已启动，开始轮询进度：\n";
    
        int completed_count = 0;
        std::vector<bool> job_done(num_profiles, false);
    
        while (completed_count < num_profiles) {
            std::string progress_line = "进度: ";
            completed_count = 0;
    
            for (int i = 0; i < num_profiles; ++i) {
                if (!job_done[i]) {
                    if (jobs[i].ready()) {
                        job_done[i] = true;
                    }
                }
                if(job_done[i]) completed_count++;
    
                int p = jobs[i].progress();
                progress_line += "P" + std::to_string(i) + ":";
                if (p < 0) progress_line += "--";
                else if (p < 10) progress_line += "  " + std::to_string(p);
                else if (p < 100) progress_line += " " + std::to_string(p);
                else progress_line += std::to_string(p);
                progress_line += "% | ";
            }
    
            std::cout << "\r" << progress_line << std::flush;
            std::this_thread::sleep_for(std::chrono::milliseconds(10));
        }
    
        std::cout << "\n\n所有任务已完成。正在获取结果并保存图片...\n";
    
        bool all_ok = true;
        for (int i = 0; i < num_profiles; ++i) {
            try {
                auto result = jobs[i].get();
                std::cout << "  - 剖面 " << i << " 成功: 网格 " << result.width << "x" << result.height << "\n";
    
                const std::filesystem::path png_path = out_dir / ("profile_" + std::to_string(i) + ".png");
                auto se = result.tl_db;
                //for (auto& data : se)
                //    data = 80 - data;
                if(!tl_png::write_tl_png(png_path.string(), result.width, result.height, se)) {
                    std::cerr << "    保存 PNG 失败: " << png_path.string() << "\n";
                    all_ok = false;
                } else {
                    std::cout << "    已保存: " << png_path.string() << "\n";
                }
    
            } catch (const std::exception& e) {
                std::cerr << "  - 剖面 " << i << " 失败: " << e.what() << "\n";
                all_ok = false;
            }
        }
    
        if (all_ok) {
            std::cout << "\n所有剖面均计算成功！输出目录: " << out_dir.string() << "\n";
            return 0;
        } else {
            std::cerr << "\n部分剖面计算/保存失败。输出目录: " << out_dir.string() << "\n";
            return 1;
        }
    }